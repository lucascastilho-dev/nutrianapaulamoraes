<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="canonical" href="https://www.nutrianapaulamoraes/faq.html" />
<link rel="icon" type="image/ico" href="img/favicon.ico">
<!-- BASE CSS -->
<link rel="stylesheet" href="css/base.css">
<!-- FONT AWESOME -->
<link rel="stylesheet" href="css/all.min.css">
<title>Agendar Consulta | Dra. Ana Paula Moraes</title>

<style>
  :root {
    --bg-color: #0f1a14;
    --card-bg: #16261b;
    --accent: #FBE39B;
    --text-white: #ffffff;
  }

  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    padding: 20px;
    background: var(--bg-color);
    color: var(--text-white);
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .container { max-width: 600px; width: 100%; text-align: center; }

  input[type="date"] {
    padding: 12px;
    border-radius: 8px;
    border: 1px solid var(--accent);
    background: var(--card-bg);
    color: white;
    font-size: 1rem;
    margin-bottom: 20px;
    width: 100%;
    max-width: 300px;
  }

  #slots {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 10px;
    margin-top: 20px;
  }

  button {
    padding: 12px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    transition: 0.3s;
    font-weight: bold;
  }

  .slot { background: var(--accent); color: #16261B; }
  .slot:hover { background: #eacb7a; transform: translateY(-2px); }

  /* MODAL */
  .modal {
    display: none; 
    position: fixed; z-index: 1000; left: 0; top: 0;
    width: 100%; height: 100%;
    background-color: rgba(0,0,0,0.8);
    backdrop-filter: blur(5px);
  }

  .modal-content {
    background: var(--card-bg);
    margin: 10% auto;
    padding: 30px;
    border: 1px solid var(--accent);
    width: 90%;
    max-width: 450px;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
  }

  .modal-header { border-bottom: 1px solid #2d4536; padding-bottom: 15px; margin-bottom: 20px; }
  .modal-header h2 { color: var(--accent); margin: 0; font-size: 1.4rem; }

  label { display: block; text-align: left; margin-top: 15px; font-size: 0.9rem; color: #ccc; }
  
  .modal-content input, .modal-content textarea {
    width: 100%; padding: 10px; margin-top: 5px;
    border-radius: 6px; border: 1px solid #3e5a49;
    background: #0f1a14; color: white; box-sizing: border-box;
  }

  .btn-confirmar {
    background: var(--accent); color: #16261B;
    width: 100%; margin-top: 25px; font-size: 1rem;
  }

  .btn-cancelar {
    background: transparent; color: #ff6b6b;
    width: 100%; margin-top: 10px; font-size: 0.8rem;
  }
</style>
</head>
<body>



<div class="container">
  <h2 class="section-title cursive center">Agendamento Online</h2>
  <p>Selecione uma data para ver os hor√°rios:</p>
  
	<div class="week-nav">
	  <button onclick="changeWeek(-1)">‚Üê Semana anterior</button>
	  <div id="weekLabel"></div>
	  <button onclick="changeWeek(1)">Pr√≥xima semana ‚Üí</button>
	</div>

	<div id="calendar" class="week"></div>
  
</div>

<div id="bookingModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Confirmar Consulta</h2>
      <p id="infoDataHora" style="color: #fff; margin-top: 5px;"></p>
    </div>
    
    <form id="formAgendamento">
      <input type="hidden" id="inputISO">
      
      <label>Nome Completo:</label>
      <input type="text" id="nome" required placeholder="Ex: Seu Nome">

      <label>WhatsApp / Telefone:</label>
      <input type="tel" id="telefone" required placeholder="(11) 99999-9999">

      <label>E-mail:</label>
      <input type="email" id="email" required placeholder="seu@email.com">

      <label>Observa√ß√µes / Motivo da Consulta:</label>
      <textarea id="obs" rows="3" placeholder="Deseja adiantar algo para a nutri?"></textarea>

      <button type="submit" class="btn-confirmar">Confirmar Agendamento</button>
      <button type="button" class="btn-cancelar" onclick="fecharModal()">Cancelar</button>
    </form>
	<div id="successMessage" style="display:none; text-align:center; margin-top:20px;">
		<h3 style="color: var(--accent);">‚ú® Consulta agendada com sucesso!</h3>
		<p style="margin-top:10px;">
			Sua consulta foi confirmada.<br>
			Voc√™ receber√° os detalhes no e-mail informado (lembrar de olhar o lixo eletr√¥nico caso email n√£o chegue).
		</p>
		<button onclick="fecharModal()" class="btn-confirmar" style="margin-top:20px;">
		Fechar
		</button> 
	</div>
  </div>
</div>

<script>
const API = "https://agenda-nutrianapaulamoraes-api.vercel.app/api";
const calendarEl = document.getElementById('calendar');
const modal = document.getElementById('bookingModal');

let currentWeekStart = getStartOfWeek(new Date());

function getStartOfWeek(date) {
  const d = new Date(date);
  const day = d.getDay();
  const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Segunda-feira
  const monday = new Date(d.setDate(diff));
  monday.setHours(12, 0, 0, 0); // Trava o fuso hor√°rio no meio do dia
  return monday;
}

function formatISO(date){
  return date.toISOString().split('T')[0];
}

/* ================= CARREGA A SEMANA INTEIRA ================= */

async function loadWeek() {
  calendarEl.innerHTML = "<p>Carregando agenda...</p>";

  // IMPORTANTE: Gerar os dias sempre a partir da currentWeekStart atualizada
  const days = [];
  for(let i=0; i<5; i++){
    const d = new Date(currentWeekStart.getTime()); // Use getTime() para copiar o valor real
    d.setDate(d.getDate() + i);
    d.setHours(12, 0, 0, 0); 
    days.push(d);
  }

  // Atualiza a legenda IMEDIATAMENTE antes de fazer o fetch
  // Isso garante que mesmo que a API demore, a data no topo j√° mudou
  const label = document.getElementById('weekLabel');
  if(label) {
    label.innerText = `${days[0].toLocaleDateString('pt-BR')} ‚Äî ${days[4].toLocaleDateString('pt-BR')}`;
  }

  // Agora segue com a busca dos dados...
  const responses = await Promise.all(
    days.map(d =>
      fetch(`${API}/availability?date=${formatISO(d)}`)
        .then(r=>r.json())
        .then(data=>data.map(dt=>new Date(dt)))
    )
  );

  renderWeekGrid(days, responses);
}

/* ===== CORRE√á√ÉO DEFINITIVA DO FUSO DO GOOGLE ===== */

function getUTCTimeKey(date){
  const h = String(date.getUTCHours()).padStart(2,'0');
  const m = String(date.getUTCMinutes()).padStart(2,'0');
  return `${h}:${m}`;
}

function sortTimes(a,b){
  return a.localeCompare(b);
}

/* ================= MONTA O GRID ================= */
function renderWeekGrid(days, weekData) {
  calendarEl.innerHTML = '';
  const agora = new Date();

  // 1. Consolidamos os hor√°rios (se houver algum)
  const allTimes = new Set();
  weekData.forEach(daySlots => {
    daySlots.forEach(d => allTimes.add(getUTCTimeKey(d)));
  });

  const times = Array.from(allTimes).sort(sortTimes);

  // 2. Verifica√ß√£o de conte√∫do
  const isSemanaPassada = days[4] < agora; 
  
  // Contamos se existe qualquer slot retornado que ainda n√£o passou da hora atual
  const totalSlotsAtivos = weekData.reduce((acc, daySlots) => {
    return acc + daySlots.filter(d => new Date(d) > agora).length;
  }, 0);

  // 3. L√≥gica de Mensagens
  if (isSemanaPassada) {
    calendarEl.innerHTML = `
      <div style="text-align:center; padding:50px; opacity:0.6;">
        <p>Esta semana j√° passou.</p>
      </div>`;
    return;
  }

  // Se a semana √© atual/futura mas n√£o h√° nenhum slot dispon√≠vel para o usu√°rio clicar
  if (totalSlotsAtivos === 0) {
    calendarEl.innerHTML = `
      <div style="text-align:center; padding:50px; border: 1px dashed rgba(255,255,255,0.1); border-radius: 20px;">
        <p style="color:var(--accent); font-weight:700; font-size:1.2rem; margin-bottom:10px;">
          Agenda lotada para esta semana!
        </p>
        <p style="opacity:0.8;">Tente navegar para a pr√≥xima semana para encontrar hor√°rios dispon√≠veis.</p>
      </div>`;
    return;
  }

  // 4. Renderiza√ß√£o do Grid (S√≥ acontece se totalSlotsAtivos > 0)
  const grid = document.createElement('div');
  grid.className = 'week-grid';

  grid.innerHTML += days.map(d => `
    <div class="day-col header-col">
      ${d.toLocaleDateString('pt-BR',{weekday:'short'})}<br>
      <span>${d.getDate()}</span>
    </div>
  `).join('');

  times.forEach(time => {
    days.forEach((day, i) => {
      const slotsDaApi = weekData[i];
      const match = slotsDaApi.find(d => getUTCTimeKey(d) === time);
      
      const [HH, MM] = time.split(':');
      const dataSlot = new Date(day);
      dataSlot.setHours(parseInt(HH), parseInt(MM), 0, 0);

      const isPassado = dataSlot < agora;

      if (match && !isPassado) {
        const horaBR = match.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});
        grid.innerHTML += `
          <div class="cell">
            <button class="slot" onclick="abrirModal('${match.toISOString()}','${horaBR}')">
              ${horaBR}
            </button>
          </div>`;
      } else {
        grid.innerHTML += `
          <div class="cell"><button class="slot disabled" disabled>${time}</button></div>`;
      }
    });
  });

  calendarEl.appendChild(grid);

 // Atualiza o texto do intervalo de datas no topo
  document.getElementById('weekLabel').innerText =
    `${days[0].toLocaleDateString('pt-BR')} ‚Äî ${days[4].toLocaleDateString('pt-BR')}`;
}
/* ================= ENVIAR AGENDAMENTO ================= */

document.getElementById('formAgendamento').onsubmit = async (e) => {
  e.preventDefault();
  
  const btnSubmit = e.target.querySelector('.btn-confirmar');
  btnSubmit.innerText = "Processando...";
  btnSubmit.disabled = true;

  const payload = {
    date: document.getElementById('inputISO').value,
    name: document.getElementById('nome').value,
    email: document.getElementById('email').value,
    phone: document.getElementById('telefone').value,
    notes: document.getElementById('obs').value
  };

  try {
    const res = await fetch(`${API}/book`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(payload)
    });

    const result = await res.json();

    if(result.ok) {
      mostrarSucesso();

      // üî• atualiza a semana ap√≥s agendar
      loadWeek();

    } else {
      alert("Erro: " + result.error);
    }
  } catch (err) {
    alert("Erro na conex√£o com o servidor.");
  } finally {
    btnSubmit.innerText = "Confirmar Agendamento";
    btnSubmit.disabled = false;
  }
};

function mostrarSucesso() {
  document.getElementById('formAgendamento').style.display = 'none';
  document.getElementById('successMessage').style.display = 'block';
}

/* ================= FECHAR MODAL CLICANDO FORA ================= */

window.onclick = (event) => {
  if (event.target == modal) fecharModal();
};

/* ================= NAVEGA√á√ÉO SEMANA ================= */

function changeWeek(offset) {
  // 1. Calculamos a nova data baseada na atual
  const novaData = new Date(currentWeekStart.getTime());
  novaData.setDate(novaData.getDate() + (offset * 7));
  
  // 2. For√ßamos a volta para a segunda-feira e limpamos o fuso
  currentWeekStart = getStartOfWeek(novaData);
  currentWeekStart.setHours(12, 0, 0, 0);

  // 3. Chamamos o carregamento
  loadWeek();
}
/* ================= MODAL ================= */

function abrirModal(dateISO, horaFormatada) {
  document.getElementById('inputISO').value = dateISO;

  const dataBR = new Date(dateISO).toLocaleDateString('pt-BR');

  document.getElementById('infoDataHora').innerText =
    `Dia: ${dataBR} √†s ${horaFormatada}`;

  modal.style.display = 'block';
}

function fecharModal() {
  modal.style.display = 'none';
  document.getElementById('formAgendamento').reset();
  document.getElementById('formAgendamento').style.display = 'block';
  document.getElementById('successMessage').style.display = 'none';
}

/* ================= BUSCA SEMANA DISPON√çVEL COM ATUALIZA√á√ÉO DE DATA ================= */

async function findFirstAvailableWeek() {
  let attempts = 0;
  let found = false;
  const agora = new Date();
  let tempStart = new Date(currentWeekStart);

  while (!found && attempts < 4) {
    const days = [];
    for (let i = 0; i < 5; i++) {
      const d = new Date(tempStart);
      d.setDate(d.getDate() + i);
      d.setHours(12, 0, 0, 0); 
      days.push(formatISO(d));
    }

    const weekResponses = await Promise.all(
      days.map(date => fetch(`${API}/availability?date=${date}`).then(r => r.json()))
    );

    const totalSlotsAtivos = weekResponses.reduce((acc, daySlots) => {
      return acc + daySlots.filter(d => new Date(d) > agora).length;
    }, 0);

    if (totalSlotsAtivos > 0) {
      found = true;
      // Atualiza a vari√°vel global para que a legenda e o loadWeek leiam a semana certa
      currentWeekStart = new Date(tempStart); 
    } else {
      tempStart.setDate(tempStart.getDate() + 7);
      attempts++;
    }
  }
  loadWeek();
}

/* ================= INICIALIZA ================= */

/* ================= INICIALIZA√á√ÉO INTELIGENTE ================= */

// Criamos uma vari√°vel para controlar se √© a primeira carga
let isFirstLoad = true;

async function inicializarAgenda() {
  if (isFirstLoad) {
    isFirstLoad = false;
    // findFirstAvailableWeek j√° termina chamando loadWeek()
    await findFirstAvailableWeek();
  } else {
    loadWeek();
  }
}

// Inicia o processo
inicializarAgenda();

//loadWeek();
</script>

</body>
</html>